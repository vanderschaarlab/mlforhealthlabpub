# Causal Assurance
##This is code for the paper "Causal Assurance for Machine Learning Robustness"


* Code has been run on an Ubuntu 18.04 Linux OS with dual Nvidia GTX 1080Ti
* All code is written and run with Python3.5+

* Required python packages are:
    *   -keras, tensorflow, scikit-learn, numpy, pandas, matplotlib, seaborn, and jupyter

* External required packages are:
    * Tetrad software from https://github.com/bd2kccd/py-causal
    * javabridge >= 1.0.11 (required installing Oracle JAVA 8 to install javabridge). Must set java8 as default configuration using the following commands (and select the java8 selection to allow javabridge install).:
    
        ``
        * sudo apt install oracle-java8-installer
        ``

        ``
        * sudo update-alternatives --config java
        ``



## EXAMPLE CAUSAL ASSURANCE USAGE
`
python3 causal_assurance.py --modeldir models/ -i abalone.csv --target_var Rings --input_vars Sex --input_vars Height --input_vars Diameter --input_vars Length --discrete Sex -l 1.0 -e Sex Height -e Sex Diameter -e Sex Length -o output.file
`

This will genereate an output file in '-o' that ranks the models specified in '--modeldir'

* '--modeldir' is a directory to your trained keras models.  Models must currently be trained identically with the same input and output ordering. 
* '-i' is the input dataset as a csv.  Headers must be strings that correspond to the edges in causal DAG.
* '-target_var' is your target variable as a string.   Models are also currently limited to a single regression output.  Note, these must correspond to your input csv.
* '--input_vars' is used to specify each input variable.  Repeat this as many times as necessary for each input variable.  Note, these must correspond to your input csv.  Additionally, the order with which these are specified must match the input order with which the model was trained.  Example: If a model was trained with A before B as inputs, then specify A before B here.
* '--discrete' is used to specify which variables are discrete (and will therefore be one hot encoded).  Repeat this as many time as necessary for each input variable.  Note, these must correspond to your input csv.
* '-l' is the lambda tuning factor to weight values between mean squred error and causal assurance metric.
* '-e' adds an edge to our known causal graph.  This must be repeated for each edge in the known DAG.  Order does not matter.
* '-o' specify an output file for ranking of models.

## GENERATE A SYNTHETIC CAUSAL DATASET
`
python3 generate_synthetic_dataset.py -e 1 2 -e 0 1 -n 4 -s 10000 -o output.csv
`

* '-e' adds an edge to our known causal graph.  This must be repeated for each edge in the known DAG.  Order does not matter.
* '-n' is the number of nodes to have in your DAG.
* '-s' is the number of samples.
* '-o' specify an output dataset (.csv).


##All experimental results can be replicated with the following notebooks:
### Notebooks used in Causal Assurance paper can be run from the 'submission' subdir with the following instructions:
* Fig 1b, 1c, 3a, 3b, and 4 start with executing Synthetic.ipynb 
    *  Set num_models to the number of models you want per run
    *  Set num_repeat to the number of times to repeat
    *  Set nodes to the number of nodes you want in your DAG.
    *  Set nbest to the number of models to select for your CAM

* All Figures in 5 and 6 can be inferred or generated by the notebooks titled Kaggle-{dataset}.ipynb
    *  Set num_models to the number of models you want per run
    *  Set num_repeat to the number of times to repeat
    *  Set dataset_path to the path to your dataset
    *  Set nbest to the number of models to select for your CAM

* To actually generate the graphs you need to run the notebook Graphs.ipynb to generate each figure
    *  Make sure that each .pkl file is generated first by the preceeding notebooks.

### Examples are shown in ./examples and datasets are stored in ./data.
